// ===================================================================
// üöÄ KIWIPAY SQUARESPACE INTEGRATION - VERSI√ìN MEJORADA
// ===================================================================
// Versi√≥n: 2.0 - Detecci√≥n autom√°tica mejorada
// Endpoint: https://loan-api-j1n6.onrender.com/api/v1/squarespace/lead
// ===================================================================

(function() {
    'use strict';
    
    // ===================================================================
    // üîß CONFIGURACI√ìN
    // ===================================================================
    const CONFIG = {
        API_URL: 'https://loan-api-j1n6.onrender.com/api/v1/squarespace/lead',
        DEBUG: true,
        MAX_RETRIES: 3,
        RETRY_DELAY: 1000,
        FORM_DETECTION_TIMEOUT: 10000
    };
    
    // ===================================================================
    // üé® ESTILOS PARA MENSAJES
    // ===================================================================
    const STYLES = {
        success: `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white; padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px; font-weight: 500; max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        `,
        error: `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white; padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px; font-weight: 500; max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        `,
        loading: `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px; font-weight: 500; max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        `
    };
    
    // ===================================================================
    // üì± UTILIDADES DE UI
    // ===================================================================
    function showMessage(message, type = 'success', duration = 5000) {
        // Remover mensajes existentes
        const existingMessages = document.querySelectorAll('.kiwipay-message');
        existingMessages.forEach(msg => msg.remove());
        
        // Crear nuevo mensaje
        const messageDiv = document.createElement('div');
        messageDiv.className = 'kiwipay-message';
        messageDiv.style.cssText = STYLES[type];
        messageDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="font-size: 18px;">
                    ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚è≥'}
                </div>
                <div>${message}</div>
            </div>
        `;
        
        document.body.appendChild(messageDiv);
        
        // Auto-remover despu√©s del tiempo especificado
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => messageDiv.remove(), 300);
            }
        }, duration);
    }
    
    // ===================================================================
    // üîç DETECCI√ìN MEJORADA DE CAMPOS
    // ===================================================================
    function detectFormFields() {
        const form = document.querySelector('form');
        if (!form) {
            console.warn('‚ùå KIWIPAY: No se encontr√≥ formulario');
            return null;
        }
        
        // Obtener todos los inputs del formulario
        const inputs = form.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="number"], select, textarea');
        const labels = form.querySelectorAll('label, .form-item-title, .field-element h3, .caption');
        
        console.log('‚úÖ KIWIPAY: üîç Analizando formulario...');
        console.log('‚úÖ KIWIPAY: üìä Inputs encontrados:', inputs.length);
        console.log('‚úÖ KIWIPAY: üè∑Ô∏è Labels encontrados:', labels.length);
        
        // Mapear campos por contenido de texto y posici√≥n
        const fieldMap = {};
        const fieldPatterns = {
            receptionistName: /recepcion|empleado|vendedor|asesor/i,
            sede: /sede|sucursal|clinica|oficina|ubicacion/i,
            clientName: /cliente|paciente|nombres.*apellidos|nombre.*completo|persona/i,
            dni: /dni|documento|cedula|identificacion|ruc/i,
            monthlyIncome: /ingreso|salario|sueldo|mensual|s\/|soles/i,
            treatmentCost: /costo|precio|tratamiento|aproximado|aprox/i,
            phone: /telefono|celular|movil|contacto|phone/i
        };
        
        // Analizar cada input
        inputs.forEach((input, index) => {
            const inputInfo = {
                element: input,
                index: index,
                type: input.type,
                name: input.name || '',
                id: input.id || '',
                placeholder: input.placeholder || '',
                value: input.value || ''
            };
            
            // Buscar label asociado
            let labelText = '';
            
            // M√©todo 1: Label con for= que apunta al input
            if (input.id) {
                const label = document.querySelector(`label[for="${input.id}"]`);
                if (label) labelText = label.textContent.trim();
            }
            
            // M√©todo 2: Label que contiene el input
            if (!labelText) {
                const parentLabel = input.closest('label');
                if (parentLabel) labelText = parentLabel.textContent.trim();
            }
            
            // M√©todo 3: Buscar elementos de texto cercanos
            if (!labelText) {
                const parent = input.closest('.form-item, .field-element, .form-wrapper, div');
                if (parent) {
                    const textElements = parent.querySelectorAll('.form-item-title, .field-element h3, .caption, label, span, div');
                    textElements.forEach(el => {
                        const text = el.textContent.trim();
                        if (text && text.length > 0 && text.length < 100) {
                            labelText = text;
                        }
                    });
                }
            }
            
            inputInfo.labelText = labelText;
            
            console.log(`‚úÖ KIWIPAY: üìã Campo ${index + 1}:`, {
                type: input.type,
                name: input.name,
                id: input.id,
                placeholder: input.placeholder,
                labelText: labelText,
                value: input.value
            });
            
            // Intentar mapear el campo
            for (const [fieldName, pattern] of Object.entries(fieldPatterns)) {
                const searchText = `${labelText} ${input.placeholder} ${input.name} ${input.id}`.toLowerCase();
                if (pattern.test(searchText)) {
                    if (!fieldMap[fieldName]) {
                        fieldMap[fieldName] = inputInfo;
                        console.log(`‚úÖ KIWIPAY: ‚úÖ ${fieldName} mapeado a campo ${index + 1}: "${labelText}"`);
                    }
                }
            }
        });
        
        // Si algunos campos no se mapearon, intentar por posici√≥n
        const unmappedFields = Object.keys(fieldPatterns).filter(field => !fieldMap[field]);
        if (unmappedFields.length > 0) {
            console.log('‚úÖ KIWIPAY: üîÑ Intentando mapeo por posici√≥n para campos faltantes:', unmappedFields);
            
            // Orden esperado basado en la imagen del formulario
            const expectedOrder = ['receptionistName', 'sede', 'clientName', 'dni', 'monthlyIncome', 'treatmentCost', 'phone'];
            
            let inputIndex = 0;
            expectedOrder.forEach(fieldName => {
                if (!fieldMap[fieldName] && inputIndex < inputs.length) {
                    fieldMap[fieldName] = {
                        element: inputs[inputIndex],
                        index: inputIndex,
                        type: inputs[inputIndex].type,
                        labelText: `Campo ${inputIndex + 1}`,
                        fallback: true
                    };
                    console.log(`‚úÖ KIWIPAY: üéØ ${fieldName} mapeado por posici√≥n a campo ${inputIndex + 1}`);
                    inputIndex++;
                }
            });
        }
        
        return { form, fieldMap, allInputs: inputs };
    }
    
    // ===================================================================
    // üìù EXTRACCI√ìN DE DATOS
    // ===================================================================
    function extractFormData(fieldMap) {
        const data = {};
        const errors = [];
        
        // Extraer datos de cada campo
        Object.entries(fieldMap).forEach(([fieldName, fieldInfo]) => {
            if (fieldInfo && fieldInfo.element) {
                let value = '';
                
                if (fieldInfo.element.tagName.toLowerCase() === 'select') {
                    value = fieldInfo.element.options[fieldInfo.element.selectedIndex]?.text || '';
                } else {
                    value = fieldInfo.element.value.trim();
                }
                
                data[fieldName] = value;
                console.log(`‚úÖ KIWIPAY: ‚úì ${fieldName}: "${value}"`);
            } else {
                data[fieldName] = '';
                console.warn(`‚ö†Ô∏è KIWIPAY: Campo ${fieldName} no mapeado`);
            }
        });
        
        // Validaciones
        const validations = [
            { field: 'dni', message: 'DNI es obligatorio', validate: v => v && v.length >= 8 },
            { field: 'monthlyIncome', message: 'Ingreso Mensual es obligatorio', validate: v => v && !isNaN(parseFloat(v)) },
            { field: 'treatmentCost', message: 'Costo de Tratamiento es obligatorio', validate: v => v && !isNaN(parseFloat(v)) },
            { field: 'phone', message: 'Tel√©fono es obligatorio', validate: v => v && v.length >= 9 }
        ];
        
        validations.forEach(({ field, message, validate }) => {
            if (!validate(data[field])) {
                errors.push(message);
            }
        });
        
        console.log('‚úÖ KIWIPAY: Datos extra√≠dos completos:', data);
        console.log('‚úÖ KIWIPAY: Validaci√≥n completada:', errors.length === 0 ? 'Sin errores' : `${errors.length} errores encontrados`, errors);
        
        return { data, errors };
    }
    
    // ===================================================================
    // üöÄ ENV√çO A LA API
    // ===================================================================
    async function sendToAPI(data) {
        try {
            console.log('‚úÖ KIWIPAY: üì° Enviando a API:', CONFIG.API_URL);
            console.log('‚úÖ KIWIPAY: üì¶ Datos a enviar:', data);
            
            showMessage('‚è≥ Enviando informaci√≥n...', 'loading', 2000);
            
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            console.log('‚úÖ KIWIPAY: üì° Respuesta del servidor:', response.status, response.statusText);
            
            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ KIWIPAY: ‚úÖ Respuesta exitosa:', result);
                showMessage('‚úÖ ¬°Informaci√≥n enviada correctamente!', 'success');
                return { success: true, data: result };
            } else {
                const errorText = await response.text();
                console.error('‚ùå KIWIPAY: Error del servidor:', response.status, errorText);
                showMessage(`‚ùå Error del servidor: ${response.status}`, 'error');
                return { success: false, error: `Error ${response.status}: ${errorText}` };
            }
            
        } catch (error) {
            console.error('‚ùå KIWIPAY: Error de red:', error);
            showMessage('‚ùå Error de conexi√≥n. Verifique su internet.', 'error');
            return { success: false, error: error.message };
        }
    }
    
    // ===================================================================
    // üéØ MANEJADOR PRINCIPAL DEL FORMULARIO
    // ===================================================================
    async function handleSubmit(event) {
        console.log('‚úÖ KIWIPAY: üöÄ === INICIANDO PROCESO DE ENV√çO ===');
        
        const formData = detectFormFields();
        if (!formData) {
            showMessage('‚ùå No se pudo detectar el formulario', 'error');
            return;
        }
        
        console.log('‚úÖ KIWIPAY: Extrayendo datos del formulario...');
        const { data, errors } = extractFormData(formData.fieldMap);
        
        if (errors.length > 0) {
            console.log('‚ùå KIWIPAY: Errores de validaci√≥n:', errors);
            showMessage(`‚ùå Error: ${errors.join(', ')}`, 'error', 8000);
            return;
        }
        
        // Prevenir el env√≠o normal del formulario
        event.preventDefault();
        event.stopPropagation();
        
        // Enviar a nuestra API
        const result = await sendToAPI(data);
        
        if (result.success) {
            // Opcional: enviar tambi√©n el formulario original despu√©s de √©xito
            // formData.form.submit();
        }
        
        console.log('‚úÖ KIWIPAY: üèÅ === FIN DEL PROCESO DE ENV√çO ===');
    }
    
    // ===================================================================
    // üîß HERRAMIENTAS DE DEBUG
    // ===================================================================
    window.KiwiPaySquarespace = {
        testFieldExtraction: () => {
            console.log('üß™ KIWIPAY: === TEST DE EXTRACCI√ìN DE CAMPOS ===');
            const formData = detectFormFields();
            if (formData) {
                const { data, errors } = extractFormData(formData.fieldMap);
                console.log('üìä Datos extra√≠dos:', data);
                console.log('‚ö†Ô∏è Errores:', errors);
                return { data, errors, fieldMap: formData.fieldMap };
            }
            return null;
        },
        
        testConnection: async () => {
            console.log('üß™ KIWIPAY: === TEST DE CONEXI√ìN ===');
            const testData = {
                receptionistName: 'Test Receptionist',
                sede: 'Test Sede',
                clientName: 'Test Client',
                dni: '12345678',
                monthlyIncome: '3000',
                treatmentCost: '5000',
                phone: '987654321'
            };
            
            return await sendToAPI(testData);
        },
        
        showFormStructure: () => {
            const form = document.querySelector('form');
            if (form) {
                console.log('üìã ESTRUCTURA DEL FORMULARIO:');
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach((input, i) => {
                    console.log(`${i + 1}. ${input.tagName} [${input.type}] - Name: "${input.name}" - ID: "${input.id}" - Placeholder: "${input.placeholder}"`);
                });
            }
        }
    };
    
    // ===================================================================
    // üöÄ INICIALIZACI√ìN
    // ===================================================================
    function init() {
        console.log('‚úÖ KIWIPAY: üéØ === INICIANDO INTEGRACI√ìN KIWIPAY SQUARESPACE ===');
        console.log('‚úÖ KIWIPAY: üìç P√°gina actual:', window.location.pathname);
        console.log('‚úÖ KIWIPAY: üîó API URL:', CONFIG.API_URL);
        
        // Esperar a que el DOM est√© completamente cargado
        if (document.readyState === 'loading') {
            console.log('‚úÖ KIWIPAY: ‚è≥ DOM cargando, esperando...');
            document.addEventListener('DOMContentLoaded', init);
            return;
        }
        
        // Agregar estilos CSS para animaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Configurar interceptor de formularios
        console.log('‚úÖ KIWIPAY: Configurando interceptor de formularios...');
        
        // Usar delegaci√≥n de eventos para capturar formularios din√°micos
        document.addEventListener('submit', function(event) {
            const form = event.target;
            if (form.tagName.toLowerCase() === 'form') {
                console.log('‚úÖ KIWIPAY: üìù Formulario detectado, interceptando env√≠o...');
                handleSubmit(event);
            }
        }, true);
        
        console.log('‚úÖ KIWIPAY: ‚úÖ Interceptor de formularios configurado');
        console.log('‚úÖ KIWIPAY: üîß Herramientas de debug disponibles en: window.KiwiPaySquarespace');
        console.log('‚úÖ KIWIPAY: üí° Prueba: KiwiPaySquarespace.testFieldExtraction() o KiwiPaySquarespace.testConnection()');
        console.log('‚úÖ KIWIPAY: üéâ === INTEGRACI√ìN KIWIPAY ACTIVADA CORRECTAMENTE ===');
        
        // Mostrar campos esperados para debug
        const expectedFields = ['receptionistName', 'sede', 'clientName', 'dni', 'monthlyIncome', 'treatmentCost', 'phone'];
        console.log('‚úÖ KIWIPAY: üìã Campos esperados:', expectedFields);
    }
    
    // Ejecutar inmediatamente o esperar a que el DOM est√© listo
    init();
    
})(); 